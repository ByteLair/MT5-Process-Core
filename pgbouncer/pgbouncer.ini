;; PgBouncer Configuration for MT5 Trading Database
;; Optimized for high-performance connection pooling

[databases]
; Database connection string
; Format: dbname = host=hostname port=5432 dbname=dbname
mt5_trading = host=db port=5432 dbname=mt5_trading
; pgbouncer pseudo-database for admin console (special database, don't define explicitly)

[pgbouncer]
;;;
;;; Administrative settings
;;;

; Logfile location
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

; Listen address and port
listen_addr = 0.0.0.0
listen_port = 5432

; Unix socket location (disabled for Docker)
unix_socket_dir =

;;;
;;; Authentication settings
;;;

; Authentication type (trust, plain, md5, cert, hba, pam)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Connection pooling settings
;;;

; Pool mode (session, transaction, statement)
; transaction: Best for most workloads, allows connection reuse between transactions
pool_mode = transaction

; Maximum number of client connections allowed
max_client_conn = 1000

; Default pool size per user/database pair
; This is the core pool size for normal operations
default_pool_size = 25

; Minimum pool size - always maintain this many connections
min_pool_size = 10

; Reserve pool size - additional connections for peak loads
reserve_pool_size = 5

; Maximum number of server connections per database
; Keep this reasonable to avoid overwhelming PostgreSQL
max_db_connections = 50

; Maximum number of server connections per user
max_user_connections = 50

;;;
;;; Timeout settings (in seconds)
;;;

; If server connection has been idle for this long, close it
; 600s = 10 minutes
server_idle_timeout = 600

; Maximum time a server connection can be used
; 3600s = 1 hour - prevents connection leaks
server_lifetime = 3600

; Maximum time to wait for server connection
server_connect_timeout = 15

; If client has not sent queries for this long, disconnect
; 0 = disabled (let application handle)
client_idle_timeout = 0

; Query timeout - 0 means disabled
; Let PostgreSQL handle query timeouts
query_timeout = 0

; Maximum time for login
query_wait_timeout = 120

; How long to wait for connection slot
; 0 = clients block indefinitely
reserve_pool_timeout = 5

;;;
;;; Connection limits
;;;

; Maximum number of prepared statements per connection
; -1 = unlimited (only works in session pooling)
; 0 = disabled (recommended for transaction pooling)
max_prepared_statements = 0

;;;
;;; Low-level network settings
;;;

; TCP socket options
so_reuseport = 1
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

; TCP user timeout (milliseconds)
; Helps detect dead connections faster
tcp_user_timeout = 30000

;;;
;;; TLS settings
;;;

; Disable TLS for internal Docker network
; Enable if exposing externally
client_tls_sslmode = disable
server_tls_sslmode = disable

;;;
;;; Logging and monitoring
;;;

; Log verbosity (0=ERROR, 1=WARNING, 2=INFO, 3=DEBUG)
verbose = 1

; Log connections and disconnections
log_connections = 1
log_disconnections = 1

; Log pooler errors
log_pooler_errors = 1

; Log statistics to log
stats_period = 60

;;;
;;; Performance tuning
;;;

; DNS lookup frequency
; 15 = 15 seconds between DNS lookups
dns_max_ttl = 15
dns_nxdomain_ttl = 15

; Disable statement-level tracking (better performance)
track_extra_parameters = none

; Ignore startup parameters that don't affect connection
; Reduces connection churn
ignore_startup_parameters = extra_float_digits,application_name

;;;
;;; Application name passthrough
;;;

; Allow application names for better monitoring
application_name_add_host = 1

;;;
;;; Admin console
;;;

; Admin users
admin_users = trader

; Stats users (can view stats but not control)
stats_users = trader

;;;
;;; Security
;;;

; Disable dangerous commands in admin console
disable_pqexec = 0

;;;
;;; Health check
;;;

; Pause mode timeout - how long to wait for transactions to complete
; when pausing the pooler
server_check_delay = 30
server_check_query = SELECT 1

;;;
;;; Resource limits
;;;

; Maximum packet size
pkt_buf = 8192

; Maximum number of cached buffers
sbuf_loopcnt = 5

; Memory for tracking prepared statements (bytes)
; Only matters if max_prepared_statements > 0
max_packet_size = 2147483647
